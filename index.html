<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinançasPro - Gestão Premium</title>
    
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDO06nr7AbOisEVS3BTl0qq0ofKqaHAB_w",
            authDomain: "planejamento-c8a35.firebaseapp.com",
            projectId: "planejamento-c8a35",
            storageBucket: "planejamento-c8a35.firebasestorage.app",
            messagingSenderId: "758113336944",
            appId: "1:758113336944:web:3b49e4160e2d387b6cbeb5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Disponibilizar Firebase globalmente
        window.firebase = { db, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Glassmorphism & Gradients */
        .card-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .gradient-text { -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ÍCONES ---
        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            Wallet: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            CreditCard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        const CATEGORIAS_ENTRADA = ["Salário", "Aluguel Casa", "Aluguel Kitnet", "Freelance", "Investimentos", "Outras Entradas"];
        const CATEGORIAS_SAIDA = ["Água", "Luz", "Internet", "Cartão Nubank", "Cartão Banco do Brasil", "Outros Parcelamentos", "Empréstimos", "Seguro do Carro", "Telefone Vivo", "Lazer", "Mercado", "Farmácia", "Combustível", "Outras Despesas"];

        // --- COMPONENTES UI ATUALIZADOS ---
        
        const CardCircular = ({ titulo, valor, Icone, gradient, subtitulo }) => (
            <div className={`
                relative group
                w-48 h-48 lg:w-56 lg:h-56
                rounded-full shadow-2xl 
                flex flex-col justify-center items-center text-center 
                ${gradient}
                border-4 border-white/20
                transform transition-all duration-300 hover:scale-105
            `}>
                <div className="absolute inset-0 rounded-full border border-white/10 scale-90 group-hover:scale-100 transition-transform"></div>
                <div className="p-3 bg-white/20 rounded-full backdrop-blur-sm mb-2 shadow-inner">
                    <Icone />
                </div>
                <p className="text-blue-50 text-xs lg:text-sm font-semibold uppercase tracking-wider mb-1 opacity-90">{titulo}</p>
                <h3 className="text-xl lg:text-2xl font-bold tracking-tight px-2 text-white drop-shadow-md">
                    {valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                </h3>
                {subtitulo && <span className="absolute bottom-6 text-[10px] font-medium bg-black/20 px-3 py-1 rounded-full text-white/90">{subtitulo}</span>}
            </div>
        );

        const Botao = ({ children, onClick, variant = 'primary', className = '' }) => {
            const baseStyle = "px-4 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2 justify-center shadow-md active:scale-95";
            const variants = {
                primary: "bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:shadow-blue-500/30",
                danger: "bg-gradient-to-r from-red-500 to-rose-600 text-white hover:shadow-red-500/30",
                success: "bg-gradient-to-r from-emerald-500 to-teal-600 text-white hover:shadow-emerald-500/30",
                purple: "bg-gradient-to-r from-purple-600 to-violet-600 text-white hover:shadow-purple-500/30",
                warning: "bg-gradient-to-r from-amber-500 to-orange-600 text-white hover:shadow-amber-500/30"
            };
            return <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`}>{children}</button>;
        };

        // --- GRÁFICOS ---
        const GraficoPizza = ({ dados }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || dados.length === 0) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: dados.map(d => d.name),
                        datasets: [{
                            data: dados.map(d => d.value),
                            backgroundColor: [
                                '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f97316', '#eab308', '#10b981', '#06b6d4'
                            ],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { usePointStyle: true, padding: 20, font: { family: 'Inter', size: 11 } } },
                            tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8 }
                        },
                        cutout: '75%'
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [dados]);

            if (dados.length === 0) return <div className="h-64 flex items-center justify-center text-gray-400 font-medium">Sem dados para este período</div>;
            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        const GraficoBarras = ({ dados }) => {
            const chartRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || dados.length === 0) return;
                if (chartRef.current) chartRef.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
                gradient.addColorStop(1, 'rgba(168, 85, 247, 0.8)');

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dados.map(d => d.mes),
                        datasets: [{
                            label: 'Despesas Provisionadas',
                            data: dados.map(d => d.valor),
                            backgroundColor: gradient,
                            borderRadius: 6,
                            barThickness: 30
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { 
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                callbacks: { label: (c) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.raw) }
                            }
                        },
                        scales: {
                            y: { grid: { borderDash: [4, 4], color: '#e2e8f0' }, border: { display: false } },
                            x: { grid: { display: false }, border: { display: false } }
                        }
                    }
                });
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [dados]);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        };

        // --- FUNÇÕES FIREBASE ---
        const useFirebaseTransacoes = () => {
            const [transacoes, setTransacoes] = useState([]);
            const [carregando, setCarregando] = useState(true);

            useEffect(() => {
                if (!window.firebase) {
                    console.log('Firebase não carregado ainda');
                    return;
                }

                const { db, collection, onSnapshot } = window.firebase;
                
                const unsubscribe = onSnapshot(collection(db, 'transacoes'), (snapshot) => {
                    const transacoesData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTransacoes(transacoesData);
                    setCarregando(false);
                }, (error) => {
                    console.error('Erro ao carregar transações:', error);
                    setCarregando(false);
                });

                return () => unsubscribe();
            }, []);

            const adicionarTransacao = async (transacao) => {
                if (!window.firebase) {
                    console.error('Firebase não disponível');
                    return false;
                }

                try {
                    const { db, collection, addDoc } = window.firebase;
                    await addDoc(collection(db, 'transacoes'), transacao);
                    return true;
                } catch (error) {
                    console.error('Erro ao adicionar transação:', error);
                    return false;
                }
            };

            const atualizarTransacao = async (id, dados) => {
                if (!window.firebase) {
                    console.error('Firebase não disponível');
                    return false;
                }

                try {
                    const { db, doc, updateDoc } = window.firebase;
                    await updateDoc(doc(db, 'transacoes', id), dados);
                    return true;
                } catch (error) {
                    console.error('Erro ao atualizar transação:', error);
                    return false;
                }
            };

            const excluirTransacao = async (id) => {
                if (!window.firebase) {
                    console.error('Firebase não disponível');
                    return false;
                }

                try {
                    const { db, doc, deleteDoc } = window.firebase;
                    await deleteDoc(doc(db, 'transacoes', id));
                    return true;
                } catch (error) {
                    console.error('Erro ao excluir transação:', error);
                    return false;
                }
            };

            return { transacoes, carregando, adicionarTransacao, atualizarTransacao, excluirTransacao };
        };

        // --- APP PRINCIPAL ---
        function App() {
            // State
            const { transacoes, carregando, adicionarTransacao, atualizarTransacao, excluirTransacao } = useFirebaseTransacoes();
            const [mesSelecionado, setMesSelecionado] = useState(new Date().getMonth());
            const [anoSelecionado, setAnoSelecionado] = useState(new Date().getFullYear());
            const [telaAtual, setTelaAtual] = useState('dashboard');
            const [menuAberto, setMenuAberto] = useState(false);
            
            // Forms State
            const [novoItem, setNovoItem] = useState({ tipo: 'saida', categoria: '', valor: '', data: '', descricao: '', observacao: '' });
            const [dadosCartao, setDadosCartao] = useState({ cardNome: 'Cartão Nubank', valorTotal: '', parcelas: 1, dataCompra: '', descricao: '', observacao: '' });

            // Cálculos CORRIGIDOS
            const dadosFiltrados = useMemo(() => {
                return transacoes.filter(t => {
                    const d = new Date(t.data + 'T12:00:00');
                    return d.getMonth() === mesSelecionado && d.getFullYear() === anoSelecionado;
                });
            }, [transacoes, mesSelecionado, anoSelecionado]);

            const resumo = useMemo(() => {
                // ENTRADAS: Todas as entradas do mês (confirmadas + pendentes)
                const entradasTotais = dadosFiltrados
                    .filter(t => t.tipo === 'entrada')
                    .reduce((acc, c) => acc + Number(c.valor), 0);
                
                // Entradas CONFIRMADAS (que já foram recebidas)
                const entradasConfirmadas = dadosFiltrados
                    .filter(t => t.tipo === 'entrada' && t.pago)
                    .reduce((acc, c) => acc + Number(c.valor), 0);
                
                // SAÍDAS: Todas as saídas do mês (pagas + pendentes)
                const saidasTotais = dadosFiltrados
                    .filter(t => t.tipo === 'saida')
                    .reduce((acc, c) => acc + Number(c.valor), 0);
                
                // Saídas CONFIRMADAS (que já foram pagas)
                const saidasConfirmadas = dadosFiltrados
                    .filter(t => t.tipo === 'saida' && t.pago)
                    .reduce((acc, c) => acc + Number(c.valor), 0);

                // SALDO DISPONÍVEL: Apenas entradas confirmadas - saídas confirmadas
                const saldoDisponivel = entradasConfirmadas - saidasConfirmadas;

                return { 
                    entradasTotais,           // Todas as entradas
                    entradasConfirmadas,      // Apenas entradas recebidas
                    entradasPendentes: entradasTotais - entradasConfirmadas,
                    
                    saidasTotais,             // Todas as saídas
                    saidasConfirmadas,        // Apenas saídas pagas
                    saidasPendentes: saidasTotais - saidasConfirmadas,
                    
                    saldoDisponivel           // Dinheiro REALMENTE disponível
                };
            }, [dadosFiltrados]);

            const previsaoSemestral = useMemo(() => {
                const hoje = new Date();
                const dados = [];
                for (let i = 1; i <= 6; i++) {
                    const dataFutura = new Date(anoSelecionado, mesSelecionado + i, 1);
                    const mes = dataFutura.getMonth();
                    const ano = dataFutura.getFullYear();
                    
                    const totalMes = transacoes
                        .filter(t => t.tipo === 'saida')
                        .filter(t => {
                            const d = new Date(t.data + 'T12:00:00');
                            return d.getMonth() === mes && d.getFullYear() === ano;
                        })
                        .reduce((acc, c) => acc + Number(c.valor), 0);
                    
                    dados.push({
                        mes: dataFutura.toLocaleString('pt-BR', { month: 'short' }).toUpperCase(),
                        valor: totalMes
                    });
                }
                return dados;
            }, [transacoes, mesSelecionado, anoSelecionado]);

            const categoriasData = useMemo(() => {
                const cats = {};
                dadosFiltrados.filter(t => t.tipo === 'saida').forEach(t => cats[t.categoria] = (cats[t.categoria] || 0) + Number(t.valor));
                return Object.keys(cats).map(c => ({ name: c, value: cats[c] }));
            }, [dadosFiltrados]);

            // Ações
            const salvarTransacao = async (e) => {
                e.preventDefault();
                if (!novoItem.valor || !novoItem.categoria || !novoItem.data) return;
                
                // Para entradas, começa como NÃO confirmado (pago = false)
                // Para saídas, começa como NÃO pago (pago = false)
                const pagoInicial = false;
                
                const transacao = { 
                    ...novoItem, 
                    valor: parseFloat(novoItem.valor), 
                    pago: pagoInicial,
                    criadoEm: new Date().toISOString()
                };
                
                const sucesso = await adicionarTransacao(transacao);
                if (sucesso) {
                    setNovoItem({ ...novoItem, valor: '', descricao: '', observacao: '' });
                    alert('Registro salvo com sucesso!');
                } else {
                    alert('Erro ao salvar registro. Tente novamente.');
                }
            };

            const gerarParcelas = async (e) => {
                e.preventDefault();
                if (!dadosCartao.valorTotal || !dadosCartao.parcelas) return;
                
                const valorParc = parseFloat(dadosCartao.valorTotal) / parseInt(dadosCartao.parcelas);
                const dataIni = new Date(dadosCartao.dataCompra + 'T12:00:00');
                
                for(let i = 0; i < parseInt(dadosCartao.parcelas); i++) {
                    const d = new Date(dataIni);
                    d.setMonth(dataIni.getMonth() + i);
                    
                    const parcela = {
                        tipo: 'saida', 
                        categoria: dadosCartao.cardNome, 
                        valor: valorParc,
                        data: d.toISOString().split('T')[0],
                        descricao: `${dadosCartao.descricao} (${i+1}/${dadosCartao.parcelas})`,
                        observacao: dadosCartao.observacao, 
                        pago: false, // Começa como não pago
                        criadoEm: new Date().toISOString()
                    };
                    
                    await adicionarTransacao(parcela);
                }
                
                alert('Parcelamento provisionado com sucesso!');
                setDadosCartao({ cardNome: 'Cartão Nubank', valorTotal: '', parcelas: 1, dataCompra: '', descricao: '', observacao: '' });
            };

            const toggleConfirmacao = async (id, pagoAtual, tipo) => {
                const sucesso = await atualizarTransacao(id, { pago: !pagoAtual });
                if (!sucesso) {
                    alert('Erro ao atualizar status. Tente novamente.');
                }
            };

            const deletarTransacao = async (id) => {
                if (confirm('Tem certeza que deseja excluir este registro?')) {
                    const sucesso = await excluirTransacao(id);
                    if (!sucesso) {
                        alert('Erro ao excluir registro. Tente novamente.');
                    }
                }
            };

            // Renders
            const renderDashboard = () => (
                <div className="space-y-12 fade-in pb-10">
                    {carregando && (
                        <div className="flex justify-center items-center py-8">
                            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                        </div>
                    )}
                    
                    {/* Painel Circular Dashboard CORRIGIDO */}
                    <div className="flex flex-col md:flex-row justify-center items-center gap-8 md:gap-12 py-6">
                        {/* Entradas Totais */}
                        <CardCircular 
                            titulo="Entradas Totais" 
                            valor={resumo.entradasTotais} 
                            Icone={Icons.ArrowUp} 
                            gradient="bg-gradient-to-br from-emerald-500 to-teal-600"
                            subtitulo={`${resumo.entradasConfirmadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} recebidas`}
                        />
                        
                        {/* Saldo Disponível - APENAS valores confirmados */}
                        <div className="transform scale-110 z-10">
                            <CardCircular 
                                titulo="Saldo Disponível" 
                                valor={resumo.saldoDisponivel} 
                                Icone={Icons.Wallet} 
                                gradient={resumo.saldoDisponivel >= 0 ? "bg-gradient-to-br from-blue-600 to-indigo-700" : "bg-gradient-to-br from-red-600 to-orange-700"}
                                subtitulo="Valores recebidos - despesas pagas" 
                            />
                        </div>

                        {/* Saídas Totais */}
                        <CardCircular 
                            titulo="Saídas Totais" 
                            valor={resumo.saidasTotais} 
                            Icone={Icons.ArrowDown} 
                            gradient="bg-gradient-to-br from-rose-500 to-red-600"
                            subtitulo={`${resumo.saidasConfirmadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })} pagas`}
                        />
                    </div>

                    {/* Dashboard de Status */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Status Entradas */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <span className="p-2 bg-emerald-100 text-emerald-600 rounded-lg"><Icons.ArrowUp/></span>
                                Status das Entradas
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                                    <span className="text-emerald-700 font-medium">Recebidas (no saldo)</span>
                                    <span className="text-emerald-600 font-bold">{resumo.entradasConfirmadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                                    <span className="text-amber-700 font-medium">Pendentes (a receber)</span>
                                    <span className="text-amber-600 font-bold">{resumo.entradasPendentes.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-700 font-medium">Total Previsto</span>
                                    <span className="text-slate-600 font-bold">{resumo.entradasTotais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                            </div>
                        </div>

                        {/* Status Saídas */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <span className="p-2 bg-rose-100 text-rose-600 rounded-lg"><Icons.ArrowDown/></span>
                                Status das Saídas
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center p-3 bg-rose-50 rounded-lg">
                                    <span className="text-rose-700 font-medium">Pagas (no saldo)</span>
                                    <span className="text-rose-600 font-bold">{resumo.saidasConfirmadas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-amber-50 rounded-lg">
                                    <span className="text-amber-700 font-medium">Pendentes (a pagar)</span>
                                    <span className="text-amber-600 font-bold">{resumo.saidasPendentes.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                                <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <span className="text-slate-700 font-medium">Total Previsto</span>
                                    <span className="text-slate-600 font-bold">{resumo.saidasTotais.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        {/* Gráfico Pizza */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 card-glass">
                            <h3 className="font-bold text-slate-700 mb-6 flex items-center gap-2">
                                <span className="p-2 bg-purple-100 text-purple-600 rounded-lg"><Icons.PieChart/></span>
                                Onde seu dinheiro está indo?
                            </h3>
                            <GraficoPizza dados={categoriasData} />
                        </div>

                        {/* Gráfico Barras */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 card-glass">
                            <h3 className="font-bold text-slate-700 mb-6 flex items-center gap-2">
                                <span className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Icons.TrendingUp/></span>
                                Previsão de Gastos (6 Meses)
                            </h3>
                            <p className="text-sm text-slate-500 mb-4">Valores já comprometidos com parcelas e agendamentos.</p>
                            <GraficoBarras dados={previsaoSemestral} />
                        </div>
                    </div>

                    {/* Alertas Rápidos */}
                    <div className="bg-amber-50 border border-amber-100 rounded-2xl p-6">
                        <h3 className="font-bold text-amber-800 flex items-center gap-2 mb-4"><Icons.Alert/> Contas Próximas do Vencimento</h3>
                        <div className="flex gap-4 overflow-x-auto pb-2">
                            {transacoes
                                .filter(t => !t.pago && t.tipo === 'saida')
                                .sort((a,b) => new Date(a.data) - new Date(b.data))
                                .slice(0, 5)
                                .map(t => (
                                    <div key={t.id} className="min-w-[200px] bg-white p-4 rounded-xl shadow-sm border border-amber-100">
                                        <p className="font-semibold text-slate-800 truncate">{t.descricao}</p>
                                        <p className="text-xs text-slate-500">{new Date(t.data).toLocaleDateString('pt-BR')}</p>
                                        <p className="font-bold text-amber-600 mt-2">{t.valor.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</p>
                                    </div>
                            ))}
                            {transacoes.filter(t => !t.pago && t.tipo === 'saida').length === 0 && <p className="text-amber-700 text-sm">Nenhuma conta pendente próxima.</p>}
                        </div>
                    </div>
                </div>
            );

            const renderForm = (tipo) => (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in">
                    {/* Formulário */}
                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 sticky top-6">
                            <div className="flex items-center gap-3 mb-6">
                                <div className={`p-3 rounded-xl ${tipo === 'entrada' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                                    <Icons.Plus />
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-800">Nova {tipo === 'entrada' ? 'Receita' : 'Despesa'}</h3>
                                    <p className="text-xs text-slate-500">Preencha os dados do lançamento</p>
                                </div>
                            </div>
                            
                            <form onSubmit={salvarTransacao} className="space-y-4">
                                <div>
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Descrição</label>
                                    <input required type="text" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={novoItem.descricao} onChange={e => setNovoItem({...novoItem, descricao: e.target.value, tipo})} placeholder="Ex: Conta de Luz" />
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Valor</label>
                                        <input required type="number" step="0.01" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={novoItem.valor} onChange={e => setNovoItem({...novoItem, valor: e.target.value, tipo})} placeholder="0,00" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Data</label>
                                        <input required type="date" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-slate-600" value={novoItem.data} onChange={e => setNovoItem({...novoItem, data: e.target.value, tipo})} />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Categoria</label>
                                    <select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" value={novoItem.categoria} onChange={e => setNovoItem({...novoItem, categoria: e.target.value, tipo})}>
                                        <option value="">Selecione...</option>
                                        {(tipo === 'entrada' ? CATEGORIAS_ENTRADA : CATEGORIAS_SAIDA).map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>

                                <div>
                                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Observação (Opcional)</label>
                                    <textarea rows="2" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm" value={novoItem.observacao} onChange={e => setNovoItem({...novoItem, observacao: e.target.value, tipo})} placeholder="Detalhes adicionais..."></textarea>
                                </div>

                                <Botao variant={tipo === 'entrada' ? 'success' : 'danger'} className="w-full mt-2">
                                    Confirmar Lançamento
                                </Botao>
                            </form>
                        </div>
                    </div>

                    {/* Lista */}
                    <div className="lg:col-span-8">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                                <h3 className="font-bold text-slate-700">Histórico de Lançamentos</h3>
                                <div className="flex gap-2">
                                    <span className="text-xs font-medium bg-slate-100 text-slate-500 px-3 py-1 rounded-full">{dadosFiltrados.filter(t => t.tipo === tipo).length} registros</span>
                                    <span className="text-xs font-medium bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full">
                                        {tipo === 'entrada' ? 'Recebidas: ' : 'Pagas: '}
                                        {dadosFiltrados.filter(t => t.tipo === tipo && t.pago).length}
                                    </span>
                                </div>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 font-semibold uppercase text-xs">
                                        <tr>
                                            <th className="p-4">Data</th>
                                            <th className="p-4">Descrição / Obs</th>
                                            <th className="p-4">Categoria</th>
                                            <th className="p-4">Valor</th>
                                            <th className="p-4 text-center">Status</th>
                                            <th className="p-4 text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {carregando ? (
                                            <tr><td colSpan="6" className="p-8 text-center text-slate-400">Carregando...</td></tr>
                                        ) : dadosFiltrados.filter(t => t.tipo === tipo).map(item => (
                                            <tr key={item.id} className="hover:bg-slate-50/50 transition-colors group">
                                                <td className="p-4 text-slate-500 font-medium whitespace-nowrap">
                                                    {new Date(item.data + 'T12:00:00').getDate().toString().padStart(2, '0')}/
                                                    {(new Date(item.data + 'T12:00:00').getMonth() + 1).toString().padStart(2, '0')}
                                                </td>
                                                <td className="p-4">
                                                    <div className="font-semibold text-slate-700">{item.descricao}</div>
                                                    {item.observacao && <div className="text-xs text-slate-400 mt-1 italic">{item.observacao}</div>}
                                                </td>
                                                <td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600">{item.categoria}</span></td>
                                                <td className={`p-4 font-bold ${tipo === 'entrada' ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                    {item.valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
                                                </td>
                                                <td className="p-4 text-center">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${item.pago 
                                                        ? 'bg-emerald-100 text-emerald-700' 
                                                        : 'bg-amber-100 text-amber-700'
                                                    }`}>
                                                        {item.pago 
                                                            ? (tipo === 'entrada' ? 'Recebido' : 'Pago')
                                                            : (tipo === 'entrada' ? 'A Receber' : 'A Pagar')
                                                        }
                                                    </span>
                                                </td>
                                                <td className="p-4">
                                                    <div className="flex justify-center gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button 
                                                            onClick={() => toggleConfirmacao(item.id, item.pago, tipo)} 
                                                            className={`p-2 rounded-lg transition-colors ${item.pago 
                                                                ? 'bg-emerald-100 text-emerald-600 hover:bg-emerald-200' 
                                                                : 'bg-amber-100 text-amber-600 hover:bg-amber-200'
                                                            }`} 
                                                            title={item.pago 
                                                                ? (tipo === 'entrada' ? 'Marcar como Não Recebido' : 'Marcar como Não Pago')
                                                                : (tipo === 'entrada' ? 'Confirmar Recebimento' : 'Confirmar Pagamento')
                                                            }
                                                        >
                                                            {item.pago ? <Icons.Check /> : <Icons.Clock />}
                                                        </button>
                                                        <button onClick={() => deletarTransacao(item.id)} className="p-2 rounded-lg bg-rose-50 text-rose-400 hover:bg-rose-100 hover:text-rose-600 transition-colors"><Icons.Trash /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                        {!carregando && dadosFiltrados.filter(t => t.tipo === tipo).length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400">Nenhum registro encontrado.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex bg-slate-50 text-slate-800 font-sans">
                    {/* Sidebar */}
                    <aside className={`fixed lg:sticky top-0 h-screen w-72 bg-[#0f172a] text-white p-6 flex flex-col transition-transform z-30 shadow-2xl ${menuAberto ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="flex items-center gap-3 mb-10 pl-2">
                            <div className="bg-gradient-to-tr from-blue-500 to-purple-500 p-2.5 rounded-xl shadow-lg shadow-blue-500/20"><Icons.Dashboard /></div>
                            <div>
                                <h1 className="text-xl font-bold tracking-tight">FinançasPro</h1>
                                <p className="text-xs text-slate-400">Gestão Inteligente</p>
                            </div>
                            <button className="ml-auto lg:hidden text-slate-400" onClick={() => setMenuAberto(false)}><Icons.X/></button>
                        </div>
                        <nav className="space-y-2 flex-1">
                            {[
                                { id: 'dashboard', label: 'Dashboard Geral', icon: Icons.Dashboard },
                                { id: 'entradas', label: 'Minhas Entradas', icon: Icons.ArrowUp },
                                { id: 'saidas', label: 'Minhas Despesas', icon: Icons.ArrowDown },
                                { id: 'cartoes', label: 'Parcelamentos', icon: Icons.CreditCard },
                            ].map(item => (
                                <button key={item.id} onClick={() => { setTelaAtual(item.id); setMenuAberto(false); }} className={`w-full flex items-center gap-3 px-4 py-3.5 rounded-xl transition-all font-medium group ${telaAtual === item.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-slate-400 hover:bg-slate-800/50 hover:text-white'}`}>
                                    <item.icon /> {item.label}
                                </button>
                            ))}
                        </nav>
                    </aside>

                    {/* Conteúdo Principal */}
                    <main className="flex-1 p-4 lg:p-8 overflow-y-auto w-full">
                        {/* Header Mobile & Filtros */}
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <div className="flex items-center w-full md:w-auto">
                                <button onClick={() => setMenuAberto(true)} className="lg:hidden p-2 mr-4 bg-white rounded-lg shadow-sm border"><Icons.Menu/></button>
                                <div>
                                    <h2 className="text-2xl font-bold text-slate-800">
                                        {telaAtual === 'dashboard' && 'Visão Geral'}
                                        {telaAtual === 'entradas' && 'Gestão de Entradas'}
                                        {telaAtual === 'saidas' && 'Gestão de Saídas'}
                                        {telaAtual === 'cartoes' && 'Simulador de Parcelas'}
                                    </h2>
                                    <p className="text-sm text-slate-500">Bem-vindo ao seu painel financeiro.</p>
                                </div>
                            </div>

                            <div className="bg-white p-1.5 rounded-xl shadow-sm border border-slate-200 flex items-center">
                                <select value={mesSelecionado} onChange={(e) => setMesSelecionado(parseInt(e.target.value))} className="bg-transparent border-none text-sm font-semibold text-slate-600 focus:ring-0 cursor-pointer outline-none px-3 py-1.5 hover:bg-slate-50 rounded-lg transition-colors">
                                    {Array.from({length: 12}, (_, i) => <option key={i} value={i}>{new Date(0, i).toLocaleString('pt-BR', {month:'long'}).toUpperCase()}</option>)}
                                </select>
                                <div className="w-px h-4 bg-slate-300 mx-1"></div>
                                <select value={anoSelecionado} onChange={(e) => setAnoSelecionado(parseInt(e.target.value))} className="bg-transparent border-none text-sm font-semibold text-slate-600 focus:ring-0 cursor-pointer outline-none px-3 py-1.5 hover:bg-slate-50 rounded-lg transition-colors">
                                    {[2023, 2024, 2025, 2026].map(a => <option key={a} value={a}>{a}</option>)}
                                </select>
                            </div>
                        </div>
                        
                        {telaAtual === 'dashboard' && renderDashboard()}
                        {(telaAtual === 'entradas' || telaAtual === 'saidas') && renderForm(telaAtual === 'entradas' ? 'entrada' : 'saida')}
                        
                        {telaAtual === 'cartoes' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 fade-in">
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="p-3 bg-purple-100 text-purple-600 rounded-xl"><Icons.CreditCard/></div>
                                        <div>
                                            <h3 className="font-bold text-slate-800 text-lg">Nova Compra Parcelada</h3>
                                            <p className="text-sm text-slate-500">O sistema dividirá o valor automaticamente</p>
                                        </div>
                                    </div>
                                    
                                    <form onSubmit={gerarParcelas} className="space-y-5">
                                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                            {['Cartão Nubank', 'Cartão Banco do Brasil', 'Outros Parcelamentos'].map(c => (
                                                <button type="button" key={c} onClick={() => setDadosCartao({...dadosCartao, cardNome: c})} className={`py-3 px-2 rounded-xl border text-xs font-bold uppercase tracking-wide transition-all ${dadosCartao.cardNome===c ? 'border-purple-500 bg-purple-50 text-purple-700 ring-2 ring-purple-100' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`}>{c}</button>
                                            ))}
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <input type="text" placeholder="Descrição (ex: TV Nova)" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" value={dadosCartao.descricao} onChange={e => setDadosCartao({...dadosCartao, descricao: e.target.value})} />
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 uppercase ml-1">Valor Total</label>
                                                    <input type="number" placeholder="R$ 0,00" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" value={dadosCartao.valorTotal} onChange={e => setDadosCartao({...dadosCartao, valorTotal: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-slate-400 uppercase ml-1">Parcelas</label>
                                                    <input type="number" placeholder="12x" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" value={dadosCartao.parcelas} onChange={e => setDadosCartao({...dadosCartao, parcelas: e.target.value})} />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">Data 1ª Parcela</label>
                                                <input type="date" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-slate-600" value={dadosCartao.dataCompra} onChange={e => setDadosCartao({...dadosCartao, dataCompra: e.target.value})} />
                                            </div>

                                            <div>
                                                <label className="text-xs font-bold text-slate-400 uppercase ml-1">Observação</label>
                                                <textarea rows="2" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none text-sm" value={dadosCartao.observacao} onChange={e => setDadosCartao({...dadosCartao, observacao: e.target.value})} placeholder="Detalhes da compra..."></textarea>
                                            </div>
                                        </div>

                                        <Botao variant="purple" className="w-full text-lg shadow-purple-500/20">
                                            Gerar Parcelamento Inteligente
                                        </Botao>
                                    </form>
                                </div>

                                <div className="bg-gradient-to-br from-purple-600 to-indigo-700 p-8 rounded-2xl shadow-xl text-white flex flex-col justify-between relative overflow-hidden">
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full -mr-16 -mt-16 blur-3xl"></div>
                                    <div className="absolute bottom-0 left-0 w-48 h-48 bg-purple-400 opacity-10 rounded-full -ml-10 -mb-10 blur-2xl"></div>
                                    
                                    <div className="relative z-10">
                                        <div className="bg-white/10 p-4 rounded-2xl w-fit mb-6 backdrop-blur-md border border-white/10">
                                            <Icons.Calendar />
                                        </div>
                                        <h3 className="text-2xl font-bold mb-2">Previsão Inteligente</h3>
                                        <p className="text-purple-100 leading-relaxed opacity-90">
                                            Ao confirmar este parcelamento, o sistema irá criar automaticamente os lançamentos nos próximos meses.
                                            <br/><br/>
                                            Você poderá ver o impacto no gráfico de <strong>Previsão de Gastos</strong> no seu Dashboard.
                                        </p>
                                    </div>
                                    <div className="mt-8 pt-6 border-t border-white/10 relative z-10">
                                        <div className="flex justify-between items-center text-sm font-medium text-purple-200">
                                            <span>Simulação:</span>
                                            <span>{dadosCartao.valorTotal && dadosCartao.parcelas ? (dadosCartao.valorTotal / dadosCartao.parcelas).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}) + ' /mês' : 'R$ 0,00 /mês'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
