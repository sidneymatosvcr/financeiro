<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Finan√ßas - Dashboard Profissional</title>
    
    <!-- React e ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK v9+ (compatibilidade) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        .progress-ring-fill {
            fill: none;
            stroke: #10b981;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3LAlM2U_NRvKZj4pSuofVRj2ttZaKfhQ",
            authDomain: "controle-1b238.firebaseapp.com",
            projectId: "controle-1b238",
            storageBucket: "controle-1b238.firebasestorage.app",
            messagingSenderId: "636394367698",
            appId: "1:636394367698:web:901bb30c91c46b936a9b0b"
        };

        const appId = 'financas-app';

        // --- FUN√á√ïES UTILIT√ÅRIAS ---
        const safeFloat = (val) => { 
            const p = parseFloat(val); 
            return isNaN(p) ? 0 : p; 
        };
        
        const safeInt = (val) => { 
            const p = parseInt(val); 
            return isNaN(p) ? 0 : p; 
        };
        
        const formatCurrency = (v) => {
            try {
                return new Intl.NumberFormat('pt-BR', { 
                    style: 'currency', 
                    currency: 'BRL' 
                }).format(safeFloat(v));
            } catch {
                return 'R$ 0,00';
            }
        };
        
        const safeDate = (d) => { 
            if (!d) return new Date(); 
            try {
                const date = new Date(d);
                return isNaN(date.getTime()) ? new Date() : date;
            } catch {
                return new Date();
            }
        };
        
        const formatDate = (d) => { 
            try { 
                return safeDate(d).toLocaleDateString('pt-BR'); 
            } catch (e) { 
                return '--/--/--'; 
            } 
        };
        
        const getDaysUntil = (d) => { 
            if (!d) return 999; 
            const n = new Date(); 
            const t = safeDate(d); 
            n.setHours(0,0,0,0); 
            t.setHours(0,0,0,0); 
            return Math.ceil((t - n) / (86400000)); 
        };

        // --- COMPONENTE GR√ÅFICO PIZZA ---
        const PieChart = ({ data, colors, darkMode }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data || data.length === 0) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.label),
                        datasets: [{
                            data: data.map(item => item.value),
                            backgroundColor: colors,
                            borderColor: darkMode ? '#374151' : '#ffffff',
                            borderWidth: 2,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: darkMode ? '#d1d5db' : '#374151',
                                    font: {
                                        size: 12
                                    },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '65%'
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, colors, darkMode]);

            if (!data || data.length === 0) {
                return (
                    <div className="chart-container flex items-center justify-center">
                        <p className="text-gray-500 dark:text-gray-400">Sem dados para exibir</p>
                    </div>
                );
            }

            return (
                <div className="chart-container">
                    <canvas ref={canvasRef} />
                </div>
            );
        };

        // --- COMPONENTE GR√ÅFICO BARRAS ---
        const BarChart = ({ data, color, darkMode }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data || data.length === 0) return;

                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.label),
                        datasets: [{
                            label: 'Valores',
                            data: data.map(item => item.value),
                            backgroundColor: color,
                            borderColor: color,
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatCurrency(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: darkMode ? '#374151' : '#e5e7eb'
                                },
                                ticks: {
                                    color: darkMode ? '#9ca3af' : '#6b7280',
                                    callback: function(value) {
                                        if (value >= 1000) {
                                            return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                                        }
                                        return formatCurrency(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: darkMode ? '#9ca3af' : '#6b7280'
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [data, color, darkMode]);

            if (!data || data.length === 0) {
                return (
                    <div className="chart-container flex items-center justify-center">
                        <p className="text-gray-500 dark:text-gray-400">Sem dados para exibir</p>
                    </div>
                );
            }

            return (
                <div className="chart-container">
                    <canvas ref={canvasRef} />
                </div>
            );
        };

        // --- COMPONENTE PROGRESSO CIRCULAR ---
        const CircularProgress = ({ value, max, color, label, darkMode }) => {
            const radius = 60;
            const circumference = 2 * Math.PI * radius;
            const progress = max > 0 ? (value / max) * circumference : 0;
            const strokeDashoffset = circumference - progress;

            const getColorClass = (color) => {
                const colors = {
                    primary: 'stroke-sky-500',
                    success: 'stroke-emerald-500',
                    danger: 'stroke-red-500',
                    warning: 'stroke-orange-500'
                };
                return colors[color] || colors.primary;
            };

            return (
                <div className="flex flex-col items-center">
                    <div className="relative">
                        <svg width="140" height="140" className="progress-ring">
                            <circle
                                className="progress-ring-bg"
                                strokeWidth="8"
                                stroke={darkMode ? '#374151' : '#e5e7eb'}
                                fill="transparent"
                                r={radius}
                                cx="70"
                                cy="70"
                            />
                            <circle
                                className={`progress-ring-fill ${getColorClass(color)}`}
                                strokeWidth="8"
                                fill="transparent"
                                r={radius}
                                cx="70"
                                cy="70"
                                strokeDasharray={circumference}
                                strokeDashoffset={strokeDashoffset}
                            />
                        </svg>
                        <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <span className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                {max > 0 ? Math.round((value / max) * 100) : 0}%
                            </span>
                            <span className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                {label}
                            </span>
                        </div>
                    </div>
                    <div className="mt-2 text-center">
                        <div className={`text-sm font-semibold ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                            {formatCurrency(value)}
                        </div>
                        <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                            de {formatCurrency(max)}
                        </div>
                    </div>
                </div>
            );
        };

        // --- LISTAS DE CATEGORIAS ---
        const CATEGORIAS_ENTRADAS = ["Sal√°rio", "Aluguel Casa", "Aluguel Kitnet", "Renda Extra", "Outros"];
        const CATEGORIAS_SAIDAS = ["Aluguel", "√Ågua", "Luz", "Internet", "Celular", "Carro", "Seguro", "Mercado", "Lazer", "Sa√∫de"];

        // --- COMPONENTE LOADING ---
        const LoadingSpinner = () => (
            <div className="h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                <div className="flex flex-col items-center gap-4">
                    <div className="loading-spinner"></div>
                    <p className="text-gray-600 dark:text-gray-400">Carregando suas finan√ßas...</p>
                </div>
            </div>
        );

        // --- HEADER ---
        const Header = ({ darkMode, toggleDarkMode, activeView, setActiveView, userId }) => {
            const tabs = [
                { id: 'dashboard', label: 'Vis√£o Geral' },
                { id: 'incomes', label: 'Entradas' },
                { id: 'expenses', label: 'Sa√≠das' },
                { id: 'installments', label: 'Parcelas' }
            ];

            return (
                <header className={`p-4 shadow-md sticky top-0 z-50 transition-colors ${
                    darkMode ? 'bg-gray-900 border-b border-gray-800 text-white' : 'bg-white border-b border-gray-200 text-gray-900'
                }`}>
                    <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <h1 className="text-xl md:text-2xl font-bold text-sky-500 flex items-center gap-2">
                            <span>üìä Dashboard Financeiro</span>
                        </h1>
                        
                        <nav className="flex flex-wrap justify-center gap-2 bg-gray-100 dark:bg-gray-800 p-1 rounded-xl w-full md:w-auto">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveView(tab.id)}
                                    className={`flex-1 md:flex-none px-3 py-2 rounded-lg text-xs md:text-sm font-semibold transition-all whitespace-nowrap ${
                                        activeView === tab.id
                                            ? 'bg-white dark:bg-gray-700 text-sky-600 dark:text-sky-400 shadow-sm border border-gray-200 dark:border-gray-600'
                                            : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200'
                                    }`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </nav>

                        <button 
                            onClick={toggleDarkMode} 
                            className={`p-2 rounded-full transition-colors ${
                                darkMode ? 'bg-gray-800 text-yellow-400 hover:bg-gray-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                            }`}
                        >
                            {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                        </button>
                    </div>
                </header>
            );
        };

        // --- FILTRO DE DATA ---
        const DateFilterBar = ({ currentDate, setCurrentDate, darkMode }) => {
            const changeMonth = (e) => { 
                const d = new Date(currentDate); 
                d.setMonth(parseInt(e.target.value)); 
                setCurrentDate(d); 
            };
            
            const changeYear = (e) => { 
                const d = new Date(currentDate); 
                d.setFullYear(parseInt(e.target.value)); 
                setCurrentDate(d); 
            };
            
            const months = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const years = [2023, 2024, 2025, 2026, 2027, 2028, 2029, 2030];
            
            const inputClass = `p-2 rounded-lg border font-medium cursor-pointer text-sm w-full md:w-auto transition-colors ${
                darkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-800'
            }`;

            return (
                <div className={`flex flex-col md:flex-row justify-between items-center gap-3 p-4 mb-6 rounded-xl shadow-sm ${
                    darkMode ? 'bg-gray-800' : 'bg-white'
                }`}>
                    <div className="flex items-center gap-3">
                        <span className={`text-sm font-bold ${
                            darkMode ? 'text-gray-300' : 'text-gray-700'
                        }`}>
                            üìÖ Per√≠odo:
                        </span>
                        <div className="flex gap-2">
                            <select value={currentDate.getMonth()} onChange={changeMonth} className={inputClass}>
                                {months.map((m, i) => (
                                    <option key={i} value={i}>{m}</option>
                                ))}
                            </select>
                            <select value={currentDate.getFullYear()} onChange={changeYear} className={inputClass}>
                                {years.map(y => (
                                    <option key={y} value={y}>{y}</option>
                                ))}
                            </select>
                        </div>
                    </div>
                    <div className={`text-lg font-bold ${
                        darkMode ? 'text-gray-300' : 'text-gray-700'
                    }`}>
                        {months[currentDate.getMonth()]} de {currentDate.getFullYear()}
                    </div>
                </div>
            );
        };

        // --- CARD ---
        const Card = ({ title, value, color, subtitle, trend, darkMode }) => {
            const getColorClass = (color) => {
                const colors = {
                    primary: { text: 'text-sky-500', border: 'border-sky-500', bg: 'bg-sky-50 dark:bg-sky-900/20' },
                    success: { text: 'text-emerald-500', border: 'border-emerald-500', bg: 'bg-emerald-50 dark:bg-emerald-900/20' },
                    danger: { text: 'text-red-500', border: 'border-red-500', bg: 'bg-red-50 dark:bg-red-900/20' },
                    warning: { text: 'text-orange-500', border: 'border-orange-500', bg: 'bg-orange-50 dark:bg-orange-900/20' }
                };
                return colors[color] || colors.primary;
            };

            const colorClass = getColorClass(color);

            return (
                <div className={`p-6 rounded-xl shadow border-l-4 ${colorClass.border} ${colorClass.bg} ${
                    darkMode ? 'text-white' : 'text-gray-900'
                }`}>
                    <h3 className={`text-sm font-semibold uppercase mb-2 ${
                        darkMode ? 'text-gray-400' : 'text-gray-500'
                    }`}>
                        {title}
                    </h3>
                    <p className={`text-2xl md:text-3xl font-extrabold ${colorClass.text} mb-1`}>
                        {formatCurrency(value)}
                    </p>
                    {subtitle && (
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {subtitle}
                        </p>
                    )}
                    {trend && (
                        <div className={`flex items-center gap-1 mt-2 text-xs ${
                            trend > 0 ? 'text-emerald-500' : 'text-red-500'
                        }`}>
                            {trend > 0 ? '‚Üó' : '‚Üò'} {Math.abs(trend)}%
                        </div>
                    )}
                </div>
            );
        };

        // --- DASHBOARD COMPLETO ---
        const DashboardView = ({ entries, currentDate, setCurrentDate, darkMode }) => {
            const stats = useMemo(() => {
                const m = currentDate.getMonth();
                const y = currentDate.getFullYear();
                
                let saldo = 0;
                let receitasTotais = 0;
                let despesasTotais = 0;
                let receitasRealizadas = 0;
                let despesasPagas = 0;
                let receitasPendentes = 0;
                let despesasPendentes = 0;
                let alertas = [];
                let categoriasReceitas = {};
                let categoriasDespesas = {};

                entries.forEach(e => {
                    const val = safeFloat(e.amount);
                    const d = safeDate(e.dueDate);
                    const isPaid = e.status === 'paid';
                    const isCredit = e.isCreditCard && safeInt(e.totalInstallments) > 1;
                    const isCurrentMonth = d.getMonth() === m && d.getFullYear() === y;

                    if (e.type === 'Receita') {
                        receitasTotais += val;
                        if (isPaid) {
                            receitasRealizadas += val;
                            saldo += val;
                        } else {
                            receitasPendentes += val;
                        }

                        if (isCurrentMonth) {
                            const categoria = e.category || 'Outras';
                            categoriasReceitas[categoria] = (categoriasReceitas[categoria] || 0) + val;
                        }

                    } else if (e.type === 'Despesa') {
                        despesasTotais += val;
                        if (isPaid) {
                            despesasPagas += val;
                            saldo -= val;
                        } else {
                            despesasPendentes += val;
                        }

                        if (isCurrentMonth) {
                            const categoria = e.category || 'Outras';
                            categoriasDespesas[categoria] = (categoriasDespesas[categoria] || 0) + val;
                        }

                        if (!isPaid && (getDaysUntil(e.dueDate) <= 7 || e.status === 'late')) {
                            alertas.push(e);
                        }
                    }
                });

                const resultadoMensal = receitasRealizadas - despesasPagas;
                const economiaPotencial = receitasTotais - despesasTotais;
                const percentualEconomia = receitasTotais > 0 ? (economiaPotencial / receitasTotais) * 100 : 0;

                const dadosReceitas = Object.entries(categoriasReceitas)
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                const dadosDespesas = Object.entries(categoriasDespesas)
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);

                const coresGrafico = [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#64748b'
                ];

                return {
                    saldo,
                    receitasTotais,
                    despesasTotais,
                    receitasRealizadas,
                    despesasPagas,
                    receitasPendentes,
                    despesasPendentes,
                    resultadoMensal,
                    economiaPotencial,
                    percentualEconomia,
                    alertas,
                    dadosReceitas,
                    dadosDespesas,
                    coresGrafico
                };
            }, [entries, currentDate]);

            return (
                <div className="space-y-6">
                    <DateFilterBar currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} />
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <Card 
                            title="Saldo Atual" 
                            value={stats.saldo} 
                            color={stats.saldo >= 0 ? 'success' : 'danger'} 
                            subtitle="Dispon√≠vel agora"
                            darkMode={darkMode}
                        />
                        <Card 
                            title="Receitas do M√™s" 
                            value={stats.receitasTotais} 
                            color="success" 
                            subtitle={`${formatCurrency(stats.receitasRealizadas)} realizadas`}
                            darkMode={darkMode}
                        />
                        <Card 
                            title="Despesas do M√™s" 
                            value={stats.despesasTotais} 
                            color="danger" 
                            subtitle={`${formatCurrency(stats.despesasPagas)} pagas`}
                            darkMode={darkMode}
                        />
                        <Card 
                            title="Resultado Mensal" 
                            value={stats.resultadoMensal} 
                            color={stats.resultadoMensal >= 0 ? 'primary' : 'warning'} 
                            subtitle="Receitas - Despesas"
                            darkMode={darkMode}
                        />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className={`p-4 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className="text-center">
                                <CircularProgress 
                                    value={stats.receitasRealizadas} 
                                    max={stats.receitasTotais} 
                                    color="success" 
                                    label="Recebido"
                                    darkMode={darkMode}
                                />
                            </div>
                        </div>
                        <div className={`p-4 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className="text-center">
                                <CircularProgress 
                                    value={stats.despesasPagas} 
                                    max={stats.despesasTotais} 
                                    color="danger" 
                                    label="Pago"
                                    darkMode={darkMode}
                                />
                            </div>
                        </div>
                        <div className={`p-4 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className="text-center">
                                <div className={`text-2xl font-bold mb-2 ${
                                    stats.economiaPotencial >= 0 ? 'text-emerald-500' : 'text-red-500'
                                }`}>
                                    {formatCurrency(stats.economiaPotencial)}
                                </div>
                                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Economia Potencial
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    {stats.percentualEconomia.toFixed(1)}% da renda
                                </div>
                            </div>
                        </div>
                        <div className={`p-4 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className="text-center">
                                <div className={`text-2xl font-bold mb-2 ${
                                    darkMode ? 'text-white' : 'text-gray-900'
                                }`}>
                                    {stats.alertas.length}
                                </div>
                                <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Alertas Ativos
                                </div>
                                <div className="text-xs text-orange-500 mt-1">
                                    Contas pr√≥ximas/atrasadas
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className={`p-6 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-lg font-bold mb-4 ${
                                darkMode ? 'text-white' : 'text-gray-900'
                            }`}>
                                üìà Receitas por Categoria
                            </h3>
                            <PieChart 
                                data={stats.dadosReceitas} 
                                colors={stats.coresGrafico}
                                darkMode={darkMode}
                            />
                        </div>

                        <div className={`p-6 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-lg font-bold mb-4 ${
                                darkMode ? 'text-white' : 'text-gray-900'
                            }`}>
                                üìâ Despesas por Categoria
                            </h3>
                            <PieChart 
                                data={stats.dadosDespesas} 
                                colors={stats.coresGrafico}
                                darkMode={darkMode}
                            />
                        </div>
                    </div>

                    <div className={`p-6 rounded-xl shadow ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <h3 className={`text-lg font-bold mb-4 ${
                            darkMode ? 'text-white' : 'text-gray-900'
                        }`}>
                            ‚öñÔ∏è Compara√ß√£o Mensal
                        </h3>
                        <BarChart 
                            data={[
                                { label: 'Receitas', value: stats.receitasTotais },
                                { label: 'Despesas', value: stats.despesasTotais },
                                { label: 'Realizado', value: stats.receitasRealizadas },
                                { label: 'Pago', value: stats.despesasPagas }
                            ]}
                            color={darkMode ? '#3b82f6' : '#2563eb'}
                            darkMode={darkMode}
                        />
                    </div>

                    <div className={`p-6 rounded-xl shadow ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <h3 className="font-bold text-lg mb-4 text-orange-500 flex items-center gap-2">
                            üîî Alertas e Pend√™ncias
                        </h3>
                        {stats.alertas.length === 0 ? (
                            <p className="text-gray-400 text-sm">üéâ Nenhuma pend√™ncia urgente este m√™s!</p>
                        ) : (
                            <div className="space-y-3">
                                {stats.alertas
                                    .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                                    .map((a, i) => (
                                        <div key={i} className={`flex justify-between items-center p-4 rounded-lg border ${
                                            darkMode ? 'border-gray-700 bg-gray-700/50' : 'border-gray-200 bg-gray-50'
                                        }`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-3 h-3 rounded-full ${
                                                    getDaysUntil(a.dueDate) < 0 ? 'bg-red-500' : 'bg-orange-500'
                                                }`}></div>
                                                <div>
                                                    <div className={`font-bold ${
                                                        darkMode ? 'text-white' : 'text-gray-800'
                                                    }`}>
                                                        {a.description}
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        Vence: {formatDate(a.dueDate)} ‚Ä¢ 
                                                        {getDaysUntil(a.dueDate) < 0 
                                                            ? ` ${Math.abs(getDaysUntil(a.dueDate))} dias atrasado` 
                                                            : ` em ${getDaysUntil(a.dueDate)} dias`
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-red-500">
                                                    {formatCurrency(a.amount)}
                                                </div>
                                                <div className={`text-xs ${
                                                    darkMode ? 'text-gray-400' : 'text-gray-500'
                                                }`}>
                                                    {a.status === 'late' ? 'Atrasado' : 'Pendente'}
                                                </div>
                                            </div>
                                        </div>
                                    ))
                                }
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className={`p-6 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-lg font-bold mb-4 text-emerald-500`}>
                                üí∞ Situa√ß√£o das Receitas
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Total Previsto:</span>
                                    <span className="font-bold text-emerald-500">{formatCurrency(stats.receitasTotais)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>J√° Recebido:</span>
                                    <span className="font-bold text-emerald-500">{formatCurrency(stats.receitasRealizadas)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>A Receber:</span>
                                    <span className="font-bold text-orange-500">{formatCurrency(stats.receitasPendentes)}</span>
                                </div>
                            </div>
                        </div>

                        <div className={`p-6 rounded-xl shadow ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-lg font-bold mb-4 text-red-500`}>
                                üí∏ Situa√ß√£o das Despesas
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>Total Previsto:</span>
                                    <span className="font-bold text-red-500">{formatCurrency(stats.despesasTotais)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>J√° Pago:</span>
                                    <span className="font-bold text-red-500">{formatCurrency(stats.despesasPagas)}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>A Pagar:</span>
                                    <span className="font-bold text-orange-500">{formatCurrency(stats.despesasPendentes)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- VIEW DE CADASTRO (Entradas / Sa√≠das) ---
        const CategoryView = ({ userId, entries, currentDate, setCurrentDate, darkMode, type }) => {
            const isIncome = type === 'Receita';
            const suggestions = isIncome ? CATEGORIAS_ENTRADAS : CATEGORIAS_SAIDAS;
            
            const getColorClass = () => {
                return isIncome ? {
                    text: 'text-emerald-500',
                    bg: 'bg-emerald-500',
                    hover: 'hover:bg-emerald-600',
                    border: 'border-emerald-500'
                } : {
                    text: 'text-red-500', 
                    bg: 'bg-red-500',
                    hover: 'hover:bg-red-600',
                    border: 'border-red-500'
                };
            };

            const [editingId, setEditingId] = useState(null);
            const initialForm = { 
                description: '', 
                category: '', 
                amount: '', 
                registrationDate: new Date().toISOString().split('T')[0],
                dueDate: new Date().toISOString().split('T')[0],
                status: 'pending', 
                observation: '',
                isCreditCard: false, 
                totalInstallments: 1, 
                paidInstallments: 0, 
                isFixed: false 
            };
            const [form, setForm] = useState(initialForm);

            const filtered = useMemo(() => {
                return entries.filter(e => {
                    if (e.type !== type) return false;
                    const d = safeDate(e.dueDate);
                    const sameMonth = d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                    return sameMonth || e.status === 'late';
                }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            }, [entries, currentDate, type]);

            const totalPeriodo = filtered.reduce((acc, curr) => acc + safeFloat(curr.amount), 0);
            const colorClass = getColorClass();

            const save = async (e) => {
                e.preventDefault();
                
                if (!form.description.trim()) {
                    alert('Descri√ß√£o √© obrigat√≥ria');
                    return;
                }
                if (safeFloat(form.amount) <= 0) {
                    alert('Valor deve ser maior que zero');
                    return;
                }

                const payload = { 
                    ...form, 
                    type, 
                    amount: safeFloat(form.amount), 
                    totalInstallments: safeInt(form.totalInstallments), 
                    paidInstallments: safeInt(form.paidInstallments),
                    userId 
                };
                
                try {
                    if (editingId) {
                        await firebase.firestore().doc(`artifacts/${appId}/users/${userId}/entries/${editingId}`).update(payload);
                    } else {
                        await firebase.firestore().collection(`artifacts/${appId}/users/${userId}/entries`).add({
                            ...payload,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    setForm(initialForm);
                    setEditingId(null);
                } catch(err) { 
                    console.error('Erro ao salvar:', err);
                    alert('Erro ao salvar. Verifique o console.');
                }
            };

            const remove = async (id) => { 
                if (confirm('Tem certeza que deseja apagar este item?')) {
                    try {
                        await firebase.firestore().doc(`artifacts/${appId}/users/${userId}/entries/${id}`).delete();
                    } catch (err) {
                        console.error('Erro ao excluir:', err);
                        alert('Erro ao excluir item.');
                    }
                }
            };

            const edit = (item) => { 
                setEditingId(item.id); 
                setForm({ 
                    ...initialForm,
                    ...item,
                    dueDate: item.dueDate || initialForm.dueDate,
                    registrationDate: item.registrationDate || item.dueDate || initialForm.registrationDate
                }); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const inputClass = `w-full p-3 rounded-lg border text-sm focus:ring-2 focus:outline-none transition-all ${
                darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400 focus:ring-sky-500' : 'bg-white border-gray-300 text-gray-900 focus:ring-sky-500'
            }`;
            
            const labelClass = `block text-xs font-bold mb-1 ml-1 ${
                darkMode ? 'text-gray-400' : 'text-gray-500'
            }`;

            return (
                <div className="grid lg:grid-cols-3 gap-6">
                    {/* FORMUL√ÅRIO */}
                    <div className={`p-5 rounded-xl shadow h-fit ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <h3 className={`font-bold text-lg mb-4 ${colorClass.text} flex items-center justify-between`}>
                            {editingId ? '‚úèÔ∏è Editando' : `‚ûï Nova ${isIncome ? 'Entrada' : 'Sa√≠da'}`}
                            {editingId && (
                                <button 
                                    onClick={() => { setEditingId(null); setForm(initialForm); }} 
                                    className="text-xs bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-2 py-1 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                                >
                                    Cancelar
                                </button>
                            )}
                        </h3>
                        
                        <div className="mb-4">
                            <label className={labelClass}>Sugest√µes:</label>
                            <div className="flex flex-wrap gap-2">
                                {suggestions.map(cat => (
                                    <button 
                                        key={cat} 
                                        type="button" 
                                        onClick={() => setForm(p => ({ ...p, description: cat, category: cat }))} 
                                        className={`text-[10px] px-2 py-1 rounded-full border transition-colors ${
                                            form.category === cat 
                                                ? `${colorClass.bg} text-white border-transparent` 
                                                : `border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700`
                                        }`}
                                    >
                                        {cat}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <form onSubmit={save} className="space-y-4">
                            <div>
                                <label className={labelClass}>Descri√ß√£o</label>
                                <input 
                                    type="text" 
                                    placeholder="Ex: Sal√°rio, Aluguel..." 
                                    required 
                                    value={form.description} 
                                    onChange={e => setForm({...form, description: e.target.value})} 
                                    className={inputClass} 
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className={labelClass}>Valor (R$)</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        min="0.01"
                                        required 
                                        value={form.amount} 
                                        onChange={e => setForm({...form, amount: e.target.value})} 
                                        className={inputClass} 
                                    />
                                </div>
                                <div>
                                    <label className={labelClass}>Status</label>
                                    <select 
                                        value={form.status} 
                                        onChange={e => setForm({...form, status: e.target.value})} 
                                        className={inputClass}
                                    >
                                        <option value="pending">Pendente</option>
                                        <option value="paid">{isIncome ? 'Recebido' : 'Pago'}</option>
                                        <option value="late">Atrasado</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className={labelClass}>Data Registro</label>
                                    <input 
                                        type="date" 
                                        required 
                                        value={form.registrationDate} 
                                        onChange={e => setForm({...form, registrationDate: e.target.value})} 
                                        className={inputClass} 
                                    />
                                </div>
                                <div>
                                    <label className={labelClass}>Vencimento</label>
                                    <input 
                                        type="date" 
                                        required 
                                        value={form.dueDate} 
                                        onChange={e => setForm({...form, dueDate: e.target.value})} 
                                        className={inputClass} 
                                    />
                                </div>
                            </div>

                            <div>
                                <label className={labelClass}>Observa√ß√µes</label>
                                <textarea 
                                    rows="2" 
                                    placeholder="Detalhes opcionais..." 
                                    value={form.observation} 
                                    onChange={e => setForm({...form, observation: e.target.value})} 
                                    className={inputClass}
                                ></textarea>
                            </div>

                            {!isIncome && (
                                <div className={`space-y-3 pt-3 p-3 rounded-lg text-sm border ${
                                    darkMode ? 'bg-gray-700/50 border-gray-600' : 'bg-gray-50 border-gray-200'
                                }`}>
                                    <label className={`flex items-center gap-2 cursor-pointer ${
                                        darkMode ? 'text-gray-300' : 'text-gray-700'
                                    }`}>
                                        <input 
                                            type="checkbox" 
                                            checked={form.isFixed} 
                                            onChange={e => setForm({...form, isFixed: e.target.checked})} 
                                            className="rounded border-gray-300 text-sky-600 focus:ring-sky-500"
                                        />
                                        Despesa Fixa (√Ågua, Luz...)
                                    </label>
                                    <label className={`flex items-center gap-2 cursor-pointer ${
                                        darkMode ? 'text-gray-300' : 'text-gray-700'
                                    }`}>
                                        <input 
                                            type="checkbox" 
                                            checked={form.isCreditCard} 
                                            onChange={e => setForm({...form, isCreditCard: e.target.checked})} 
                                            className="rounded border-gray-300 text-sky-600 focus:ring-sky-500"
                                        />
                                        Parcelado / Empr√©stimo
                                    </label>

                                    {form.isCreditCard && (
                                        <div className="grid grid-cols-2 gap-2 mt-2">
                                            <input 
                                                type="number" 
                                                placeholder="Total Parc." 
                                                min="1" 
                                                value={form.totalInstallments} 
                                                onChange={e => setForm({...form, totalInstallments: e.target.value})} 
                                                className={inputClass} 
                                            />
                                            <input 
                                                type="number" 
                                                placeholder="Pagas" 
                                                min="0" 
                                                value={form.paidInstallments} 
                                                onChange={e => setForm({...form, paidInstallments: e.target.value})} 
                                                className={inputClass} 
                                            />
                                        </div>
                                    )}
                                </div>
                            )}

                            <button 
                                type="submit" 
                                className={`w-full py-3 rounded-lg font-bold text-white ${colorClass.bg} ${colorClass.hover} shadow-md transform active:scale-95 transition-all`}
                            >
                                {editingId ? 'Salvar Altera√ß√µes' : 'Adicionar'}
                            </button>
                        </form>
                    </div>

                    {/* LISTAGEM */}
                    <div className="lg:col-span-2 space-y-4">
                        <DateFilterBar currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} />
                        
                        <div className={`p-4 rounded-xl shadow flex justify-between items-center ${
                            darkMode ? 'bg-gray-700 text-white' : 'bg-gray-100 text-gray-800'
                        }`}>
                            <span className="font-bold text-sm md:text-base">Total no Per√≠odo:</span>
                            <span className={`text-xl md:text-2xl font-extrabold ${colorClass.text}`}>
                                {formatCurrency(totalPeriodo)}
                            </span>
                        </div>

                        <div className={`rounded-xl shadow overflow-hidden ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            {filtered.length === 0 ? (
                                <div className="p-8 text-center opacity-50 text-sm">
                                    Nenhum registro encontrado neste m√™s.
                                </div>
                            ) : (
                                <div className="flex flex-col">
                                    {filtered.map(item => (
                                        <div 
                                            key={item.id} 
                                            className={`p-4 border-b last:border-0 hover:bg-black/5 transition-colors ${
                                                darkMode ? 'border-gray-700 hover:bg-white/5' : 'border-gray-100'
                                            }`}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className={`font-bold text-base ${
                                                        darkMode ? 'text-gray-200' : 'text-gray-800'
                                                    }`}>
                                                        {item.description}
                                                    </div>
                                                    <div className="flex flex-wrap gap-1 mt-1">
                                                        {item.isFixed && (
                                                            <span className="text-[10px] bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded font-bold">
                                                                FIXA
                                                            </span>
                                                        )}
                                                        {item.isCreditCard && (
                                                            <span className="text-[10px] bg-purple-100 text-purple-800 px-1.5 py-0.5 rounded font-bold">
                                                                PARC {item.paidInstallments}/{item.totalInstallments}
                                                            </span>
                                                        )}
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${
                                                            item.status === 'paid' 
                                                                ? 'bg-green-100 text-green-800' 
                                                                : item.status === 'late' 
                                                                ? 'bg-red-100 text-red-800' 
                                                                : 'bg-yellow-100 text-yellow-800'
                                                        }`}>
                                                            {item.status === 'paid' 
                                                                ? (isIncome ? 'RECEBIDO' : 'PAGO') 
                                                                : item.status === 'late' 
                                                                ? 'ATRASADO' 
                                                                : 'PENDENTE'
                                                            }
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className={`text-lg font-bold ${colorClass.text} whitespace-nowrap`}>
                                                    {formatCurrency(item.amount)}
                                                </div>
                                            </div>
                                            
                                            <div className={`text-xs grid grid-cols-1 sm:grid-cols-2 gap-1 mt-2 p-2 rounded ${
                                                darkMode ? 'bg-gray-700/50 text-gray-400' : 'bg-gray-50 text-gray-500'
                                            }`}>
                                                <div>
                                                    üìÖ <span className="font-semibold">Registro:</span> {formatDate(item.registrationDate)}
                                                </div>
                                                <div>
                                                    ‚è≥ <span className="font-semibold">Vencimento:</span> {formatDate(item.dueDate)}
                                                </div>
                                                {item.observation && (
                                                    <div className="sm:col-span-2 mt-1 italic">
                                                        üìù {item.observation}
                                                    </div>
                                                )}
                                            </div>

                                            <div className="flex justify-end gap-3 mt-3">
                                                <button 
                                                    onClick={() => edit(item)} 
                                                    className="text-sm text-blue-500 hover:text-blue-700 font-semibold flex items-center gap-1 transition-colors"
                                                >
                                                    ‚úèÔ∏è Editar
                                                </button>
                                                <button 
                                                    onClick={() => remove(item.id)} 
                                                    className="text-sm text-red-500 hover:text-red-700 font-semibold flex items-center gap-1 transition-colors"
                                                >
                                                    üóëÔ∏è Excluir
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PARCELAS COM SISTEMA DE QUITA√á√ÉO ---
        const InstallmentsView = ({ entries, darkMode, userId }) => {
            const [payingInstallment, setPayingInstallment] = useState(null);

            const { list, groupedByParent } = useMemo(() => {
                let l = [];
                let grouped = {};

                entries
                    .filter(e => e.isCreditCard && safeInt(e.totalInstallments) > 1)
                    .forEach(e => {
                        const val = safeFloat(e.amount) / safeInt(e.totalInstallments);
                        const total = safeInt(e.totalInstallments);
                        const paid = safeInt(e.paidInstallments);
                        
                        grouped[e.id] = {
                            parent: e,
                            installments: []
                        };

                        for(let i = 0; i < total; i++) {
                            const d = new Date(safeDate(e.dueDate)); 
                            d.setMonth(d.getMonth() + i);
                            
                            const installment = { 
                                uniqueId: `${e.id}_${i}`,
                                parentId: e.id,
                                description: e.description, 
                                current: i + 1, 
                                total, 
                                amount: val, 
                                dueDate: d,
                                isPaid: i < paid,
                                status: i < paid ? 'paid' : (d < new Date() ? 'late' : 'pending')
                            };
                            
                            l.push(installment);
                            grouped[e.id].installments.push(installment);
                        }
                    });
                
                return { 
                    list: l.sort((a, b) => a.dueDate - b.dueDate),
                    groupedByParent: grouped 
                };
            }, [entries]);

            const totalPendente = list.filter(i => !i.isPaid).reduce((acc, curr) => acc + safeFloat(curr.amount), 0);
            const totalQuitado = list.filter(i => i.isPaid).reduce((acc, curr) => acc + safeFloat(curr.amount), 0);
            const parcelasPendentes = list.filter(i => !i.isPaid).length;
            const parcelasQuitadas = list.filter(i => i.isPaid).length;

            const payInstallment = async (installment) => {
                setPayingInstallment(installment.uniqueId);
                
                try {
                    const parentEntry = entries.find(e => e.id === installment.parentId);
                    if (!parentEntry) {
                        throw new Error('Entrada pai n√£o encontrada');
                    }

                    const newPaidInstallments = installment.current;
                    
                    // Atualiza a entrada pai com a nova quantidade de parcelas pagas
                    await firebase.firestore()
                        .doc(`artifacts/${appId}/users/${userId}/entries/${installment.parentId}`)
                        .update({
                            paidInstallments: newPaidInstallments,
                            status: newPaidInstallments === parentEntry.totalInstallments ? 'paid' : 'pending',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    console.log(`Parcela ${installment.current}/${installment.total} quitada com sucesso!`);
                    
                } catch (err) {
                    console.error('Erro ao quitar parcela:', err);
                    alert('Erro ao quitar parcela. Verifique o console.');
                } finally {
                    setPayingInstallment(null);
                }
            };

            const payAllInstallments = async (parentId) => {
                const parent = groupedByParent[parentId];
                if (!parent) return;

                try {
                    // Marca todas as parcelas como pagas
                    await firebase.firestore()
                        .doc(`artifacts/${appId}/users/${userId}/entries/${parentId}`)
                        .update({
                            paidInstallments: parent.parent.totalInstallments,
                            status: 'paid',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    console.log(`Todas as parcelas de ${parent.parent.description} quitadas!`);
                    
                } catch (err) {
                    console.error('Erro ao quitar todas as parcelas:', err);
                    alert('Erro ao quitar parcelas. Verifique o console.');
                }
            };

            const pendingInstallments = list.filter(i => !i.isPaid);
            const paidInstallments = list.filter(i => i.isPaid);

            return (
                <div className="space-y-6">
                    <div className={`p-6 rounded-xl shadow ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <h2 className={`text-xl font-bold mb-2 ${
                            darkMode ? 'text-white' : 'text-gray-800'
                        }`}>
                            üìÖ Sistema de Parcelas
                        </h2>
                        <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            Gerencie e quite suas parcelas pendentes
                        </p>
                    </div>

                    {/* CARDS DE RESUMO */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div className={`p-4 rounded-xl shadow border-l-4 border-orange-500 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-xs font-bold uppercase mb-1 ${
                                darkMode ? 'text-gray-400' : 'text-gray-500'
                            }`}>Total Pendente</h3>
                            <p className={`text-xl md:text-2xl font-extrabold text-orange-500`}>
                                {formatCurrency(totalPendente)}
                            </p>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-1`}>
                                {parcelasPendentes} parcelas
                            </p>
                        </div>
                        <div className={`p-4 rounded-xl shadow border-l-4 border-emerald-500 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-xs font-bold uppercase mb-1 ${
                                darkMode ? 'text-gray-400' : 'text-gray-500'
                            }`}>Total Quitado</h3>
                            <p className={`text-xl md:text-2xl font-extrabold text-emerald-500`}>
                                {formatCurrency(totalQuitado)}
                            </p>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-1`}>
                                {parcelasQuitadas} parcelas
                            </p>
                        </div>
                        <div className={`p-4 rounded-xl shadow border-l-4 border-purple-500 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-xs font-bold uppercase mb-1 ${
                                darkMode ? 'text-gray-400' : 'text-gray-500'
                            }`}>Pr√≥ximo Vencimento</h3>
                            <p className={`text-xl md:text-2xl font-extrabold text-purple-500`}>
                                {pendingInstallments.length > 0 ? formatDate(pendingInstallments[0].dueDate) : '--/--/--'}
                            </p>
                            {pendingInstallments.length > 0 && (
                                <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-1`}>
                                    {formatCurrency(pendingInstallments[0].amount)}
                                </p>
                            )}
                        </div>
                        <div className={`p-4 rounded-xl shadow border-l-4 border-blue-500 ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <h3 className={`text-xs font-bold uppercase mb-1 ${
                                darkMode ? 'text-gray-400' : 'text-gray-500'
                            }`}>Compras Parceladas</h3>
                            <p className={`text-xl md:text-2xl font-extrabold text-blue-500`}>
                                {Object.keys(groupedByParent).length}
                            </p>
                            <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} mt-1`}>
                                {list.length} parcelas no total
                            </p>
                        </div>
                    </div>

                    {/* PARCELAS PENDENTES */}
                    <div className={`rounded-xl shadow overflow-hidden ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <div className={`p-4 border-b ${
                            darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                        }`}>
                            <h3 className={`text-lg font-bold ${
                                darkMode ? 'text-white' : 'text-gray-800'
                            }`}>
                                ‚è≥ Parcelas Pendentes ({pendingInstallments.length})
                            </h3>
                        </div>

                        {pendingInstallments.length === 0 ? (
                            <div className="p-8 text-center text-gray-500 dark:text-gray-400">
                                <div className="text-4xl mb-4">üéâ</div>
                                <p className="text-lg font-semibold mb-2">Nenhuma parcela pendente!</p>
                                <p className="text-sm">Todas as suas parcelas est√£o em dia.</p>
                            </div>
                        ) : (
                            <div className="flex flex-col">
                                {pendingInstallments.map(installment => {
                                    const daysUntil = getDaysUntil(installment.dueDate);
                                    const isLate = daysUntil < 0;
                                    const isSoon = daysUntil <= 7 && daysUntil >= 0;
                                    const parent = groupedByParent[installment.parentId];
                                    
                                    return (
                                        <div 
                                            key={installment.uniqueId} 
                                            className={`flex justify-between items-center p-4 border-b last:border-0 transition-colors ${
                                                isLate ? 'bg-red-50 dark:bg-red-900/20 border-l-4 border-l-red-500' :
                                                isSoon ? 'bg-orange-50 dark:bg-orange-900/20 border-l-4 border-l-orange-500' :
                                                darkMode ? 'border-gray-700 hover:bg-white/5' : 'border-gray-100 hover:bg-gray-50'
                                            }`}
                                        >
                                            <div className="flex-1">
                                                <div className={`font-bold text-sm ${
                                                    darkMode ? 'text-gray-200' : 'text-gray-800'
                                                }`}>
                                                    {installment.description}
                                                </div>
                                                <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                    Parcela {installment.current}/{installment.total} ‚Ä¢ 
                                                    Vence: {formatDate(installment.dueDate.toISOString())} ‚Ä¢ 
                                                    {isLate ? ` ${Math.abs(daysUntil)} dias atrasado` :
                                                     isSoon ? ` em ${daysUntil} dias` :
                                                     ` em ${daysUntil} dias`}
                                                </div>
                                                {parent && (
                                                    <div className="text-xs text-blue-500 dark:text-blue-400 mt-1">
                                                        {parent.parent.paidInstallments}/{parent.parent.totalInstallments} parcelas pagas
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <div className="text-right">
                                                    <div className="font-bold text-red-500">
                                                        {formatCurrency(installment.amount)}
                                                    </div>
                                                    <div className={`text-xs ${
                                                        isLate ? 'text-red-500 font-bold' :
                                                        isSoon ? 'text-orange-500' :
                                                        darkMode ? 'text-gray-400' : 'text-gray-500'
                                                    }`}>
                                                        {isLate ? 'ATRASADO' : isSoon ? 'PR√ìXIMO' : 'PENDENTE'}
                                                    </div>
                                                </div>
                                                <button 
                                                    onClick={() => payInstallment(installment)}
                                                    disabled={payingInstallment === installment.uniqueId}
                                                    className={`px-3 py-2 rounded-lg font-semibold text-white transition-all ${
                                                        payingInstallment === installment.uniqueId
                                                            ? 'bg-gray-400 cursor-not-allowed'
                                                            : 'bg-emerald-500 hover:bg-emerald-600'
                                                    }`}
                                                >
                                                    {payingInstallment === installment.uniqueId ? 'üí´' : 'üí≥'}
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* PARCELAS QUITADAS */}
                    {paidInstallments.length > 0 && (
                        <div className={`rounded-xl shadow overflow-hidden ${
                            darkMode ? 'bg-gray-800' : 'bg-white'
                        }`}>
                            <div className={`p-4 border-b ${
                                darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                            }`}>
                                <h3 className={`text-lg font-bold ${
                                    darkMode ? 'text-white' : 'text-gray-800'
                                }`}>
                                    ‚úÖ Parcelas Quitadas ({paidInstallments.length})
                                </h3>
                            </div>
                            <div className="flex flex-col">
                                {paidInstallments.slice(0, 10).map(installment => (
                                    <div 
                                        key={installment.uniqueId} 
                                        className={`flex justify-between items-center p-4 border-b last:border-0 ${
                                            darkMode ? 'border-gray-700 hover:bg-white/5' : 'border-gray-100 hover:bg-gray-50'
                                        }`}
                                    >
                                        <div className="flex-1">
                                            <div className={`font-bold text-sm ${
                                                darkMode ? 'text-gray-200' : 'text-gray-800'
                                            }`}>
                                                {installment.description}
                                            </div>
                                            <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                Parcela {installment.current}/{installment.total} ‚Ä¢ 
                                                Paga em: {formatDate(new Date().toISOString())}
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className="font-bold text-emerald-500">
                                                {formatCurrency(installment.amount)}
                                            </div>
                                            <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                                QUITADO
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {paidInstallments.length > 10 && (
                                    <div className={`p-4 text-center text-sm ${
                                        darkMode ? 'text-gray-400' : 'text-gray-500'
                                    }`}>
                                        + {paidInstallments.length - 10} parcelas quitadas
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* COMPRAS PARCELADAS - VIS√ÉO GERAL */}
                    <div className={`rounded-xl shadow overflow-hidden ${
                        darkMode ? 'bg-gray-800' : 'bg-white'
                    }`}>
                        <div className={`p-4 border-b ${
                            darkMode ? 'border-gray-700 bg-gray-700' : 'border-gray-200 bg-gray-50'
                        }`}>
                            <h3 className={`text-lg font-bold ${
                                darkMode ? 'text-white' : 'text-gray-800'
                            }`}>
                                üõí Compras Parceladas
                            </h3>
                        </div>
                        <div className="flex flex-col">
                            {Object.entries(groupedByParent).map(([parentId, group]) => {
                                const pendingCount = group.installments.filter(i => !i.isPaid).length;
                                const paidCount = group.installments.filter(i => i.isPaid).length;
                                const totalAmount = group.parent.amount;
                                const paidAmount = paidCount * (totalAmount / group.parent.totalInstallments);
                                
                                return (
                                    <div 
                                        key={parentId}
                                        className={`flex justify-between items-center p-4 border-b last:border-0 ${
                                            darkMode ? 'border-gray-700 hover:bg-white/5' : 'border-gray-100 hover:bg-gray-50'
                                        }`}
                                    >
                                        <div className="flex-1">
                                            <div className={`font-bold text-sm ${
                                                darkMode ? 'text-gray-200' : 'text-gray-800'
                                            }`}>
                                                {group.parent.description}
                                            </div>
                                            <div className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                {paidCount}/{group.parent.totalInstallments} parcelas pagas ‚Ä¢ 
                                                Total: {formatCurrency(totalAmount)}
                                            </div>
                                            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mt-2">
                                                <div 
                                                    className="bg-emerald-500 h-2 rounded-full transition-all"
                                                    style={{ width: `${(paidCount / group.parent.totalInstallments) * 100}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <div className="text-right">
                                                <div className="font-bold text-orange-500">
                                                    {formatCurrency(totalAmount - paidAmount)}
                                                </div>
                                                <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                                                    Restante
                                                </div>
                                            </div>
                                            {pendingCount > 0 && (
                                                <button 
                                                    onClick={() => payAllInstallments(parentId)}
                                                    className="px-3 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors"
                                                >
                                                    Quitar Todas
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [darkMode, setDarkMode] = useState(false);
            const [activeView, setActiveView] = useState('dashboard');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [userId, setUserId] = useState(null);
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Verificar se o Firebase j√° foi inicializado
                        if (!firebase.apps.length) {
                            firebase.initializeApp(firebaseConfig);
                        }
                        console.log('Firebase inicializado com sucesso!');
                        
                        firebase.auth().onAuthStateChanged(async (user) => {
                            try {
                                if (user) {
                                    console.log('Usu√°rio logado:', user.uid);
                                    setUserId(user.uid);
                                    
                                    const unsubscribe = firebase.firestore()
                                        .collection(`artifacts/${appId}/users/${user.uid}/entries`)
                                        .onSnapshot((snapshot) => {
                                            const entriesData = snapshot.docs.map(doc => ({ 
                                                id: doc.id, 
                                                ...doc.data() 
                                            }));
                                            console.log('Dados carregados:', entriesData.length, 'registros');
                                            setEntries(entriesData);
                                            setLoading(false);
                                            setError(null);
                                        }, (err) => {
                                            console.error('Erro no snapshot:', err);
                                            setError('Erro ao carregar dados do Firestore');
                                            setLoading(false);
                                        });
                                } else {
                                    console.log('Fazendo login an√¥nimo...');
                                    await firebase.auth().signInAnonymously();
                                }
                            } catch (err) {
                                console.error('Erro na autentica√ß√£o:', err);
                                setError('Erro de autentica√ß√£o: ' + err.message);
                                setLoading(false);
                            }
                        });

                    } catch (err) {
                        console.error('Erro na inicializa√ß√£o do Firebase:', err);
                        setError('Erro ao conectar com o Firebase: ' + err.message);
                        setLoading(false);
                    }
                };

                initializeFirebase();
            }, []);

            if (loading) {
                return <LoadingSpinner />;
            }

            if (error) {
                return (
                    <div className="h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
                        <div className="text-center p-8 max-w-md">
                            <div className="text-red-500 text-6xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-2">Erro de Conex√£o</h2>
                            <p className="text-gray-600 dark:text-gray-400 mb-4">{error}</p>
                            <button 
                                onClick={() => window.location.reload()} 
                                className="w-full bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition-colors"
                            >
                                Tentar Novamente
                            </button>
                        </div>
                    </div>
                );
            }

            const renderContent = () => {
                switch(activeView) {
                    case 'dashboard': 
                        return <DashboardView entries={entries} currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} />;
                    case 'incomes': 
                        return <CategoryView userId={userId} entries={entries} currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} type="Receita" />;
                    case 'expenses': 
                        return <CategoryView userId={userId} entries={entries} currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} type="Despesa" />;
                    case 'installments': 
                        return <InstallmentsView entries={entries} darkMode={darkMode} userId={userId} />;
                    default: 
                        return <DashboardView entries={entries} currentDate={currentDate} setCurrentDate={setCurrentDate} darkMode={darkMode} />;
                }
            };

            return (
                <div className={`min-h-screen font-sans transition-colors duration-200 pb-10 ${
                    darkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-50 text-gray-800'
                }`}>
                    <Header 
                        darkMode={darkMode} 
                        toggleDarkMode={() => setDarkMode(!darkMode)} 
                        activeView={activeView} 
                        setActiveView={setActiveView} 
                        userId={userId} 
                    />
                    <main className="max-w-7xl mx-auto p-4">
                        {renderContent()}
                    </main>
                </div>
            );
        }

        // Renderiza a aplica√ß√£o
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
